+++
title = 'Менее известные особенности Clickhouse. Часть 2'
date = 2024-01-24T18:31:41+03:00
draft = true
+++

# Менее известные особенности Clickhouse. Часть 2

## Составные агрегационные функции

Агрегационные функции в `Clickhouse` можно расширять суффиксами, которые меняют поведение этой функции.

Классический пример, суффикс `-If`, позволяет учитывать в агрегационной функции только значения, соответствующие условию:

```sql
SELECT topKIf(10)(sales, date >= '2024-01-01')
FROM sales_table;
```

Вычислит топ 10 значений продаж в 2024 году.

Еще один пример: суффикс `-Array` повзоляет применить агрегационную функцию на все элементы в массивах, во всем столбце.
При этом это будет аналогично использованию `arrayJoin` (аналог `Unnest` в `PostgreSQL`) с последующим применением агрегационной функции без суффикса.

`-Array` можно применять вместе с суффиксом `-If`, что также позволит отсеять значения по условию.

```sql
SELECT sumArrayIf(sales_array, region = 'Europe')
FROM world_sales;
```

Позволит просуммировать все значения продаж по Европе, если их значения хранятся в массиве.
Запрос выше является более простым способом применения следующего запроса:

```sql
SELECT
    sum(arrayJoin(sales_array)) t
FROM world_sales
WHERE region = 'Europe`;
```

Однако мы не вседа хотим использовать `arrayJoin`, так как он изменит структуру результата.

Суффиксы можно комбинировать практически не ограниченно (влоть до конструкции вроде `sumForEachStateIfArrayIfState`), порядок указания может быть важен, однако, к сожалению, не всегда прозрачно указан в документации.

Другие суффиксы можно посмотреть в [документации](https://clickhouse.com/docs/en/sql-reference/aggregate-functions/combinators) к `Clickhouse`.
